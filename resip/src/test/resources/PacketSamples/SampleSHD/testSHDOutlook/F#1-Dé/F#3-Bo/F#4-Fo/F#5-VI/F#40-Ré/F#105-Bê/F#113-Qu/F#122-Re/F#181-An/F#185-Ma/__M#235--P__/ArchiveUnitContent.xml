<Content>
    <DescriptionLevel>Item</DescriptionLevel>
    <Title>[Projet VITAM 0000022]: Impossibilité d&apos;effectuer une query si plusieurs éléments dans roots</Title>
    <OriginatingSystemId>&lt;1b8e3015d6f910c39a5cd638602b5505@213.32.79.242&gt;</OriginatingSystemId>
    <Writer>
        <FirstName>Mantis Bug Tracker</FirstName>
        <BirthName>Mantis Bug Tracker</BirthName>
        <Identifier>admtlvitam@gmail.com</Identifier>
    </Writer>
    <Addressee>
        <FirstName>thierry.casimirius</FirstName>
        <BirthName>thierry.casimirius</BirthName>
        <Identifier>thierry.casimirius@intradef.gouv.fr</Identifier>
    </Addressee>
    <SentDate>2016-12-19T13:09:57Z</SentDate>
    <ReceivedDate>2016-12-19T13:10:02Z</ReceivedDate>
    <TextContent>Le bogue suivant a été soumis. 
====================================================================== 
http://213.32.79.242/mantisbt/view.php?id=22 
====================================================================== 
Rapporteur:                 Franck
Responsable:                
====================================================================== 
Projet:                     Projet VITAM
Bogue ID:                   22
Catégorie:                  BugFromTestlink
Reproductibilité:           toujours
Impact:                     majeur
Priorité:                   normale
Statut:                     nouveau
Comportement attendu:        
US concernée:                
====================================================================== 
Date de soumission:         2016-12-19 14:09 CET
Dernière modification:      2016-12-19 14:09 CET
====================================================================== 
Résumé:                     Impossibilité d&apos;effectuer une query si plusieurs
éléments dans roots
Description: 
Lorsque l&apos;on veut effectuer une requête dans un sous-ensemble défini dans le
roots, celle ci ne fonctionne pas.

Nous effectuons notre test dans la collection Unit
Notre requête &quot;$eq&quot; seule fonctionne :

{
  &quot;$roots&quot;: [],
  &quot;$query&quot;: [

      {
          &quot;$eq&quot;: {
            &quot;Title&quot;: &quot;PVI58fic_pour_empreinte_Appraisalerule&quot;
          }
        
      ,
      &quot;$depth&quot;: 20
    }
  ],
  &quot;$filter&quot;: {
    &quot;$orderby&quot;: {
      &quot;TransactedDate&quot;: 1
    }
  },
  &quot;$projection&quot;: {
    &quot;$fields&quot;: {
      &quot;TransactedDate&quot;: 1,
      &quot;#id&quot;: 1,
      &quot;Title&quot;: 1,
      &quot;#object&quot;: 1
    }
  }
}

Cette requête nous donne bien la unit recherchée:

{
   &quot;$hits&quot;:    {
      &quot;total&quot;: 1,
      &quot;offset&quot;: 0,
      &quot;limit&quot;: 1,
      &quot;size&quot;: 1
   },
   &quot;$results&quot;: [   {
      &quot;Title&quot;: &quot;PVI58fic_pour_empreinte_Appraisalerule&quot;,
      &quot;TransactedDate&quot;: &quot;2016-12-08T17:53:38&quot;,
      &quot;#id&quot;: &quot;aeaaaaaaaaaam7mxaaa3gaky35ur6miaaaaq&quot;,
      &quot;#tenant&quot;: 0,
      &quot;#object&quot;: &quot;aeaaaaaaaaaam7mxaaa3gaky35ur56yaaaba&quot;
   }],
   &quot;$context&quot;:    {
      &quot;$roots&quot;: [],
      &quot;$query&quot;: [{&quot;$eq&quot;: {&quot;Title&quot;: &quot;PVI58fic_pour_empreinte_Appraisalerule&quot;}}],
      &quot;$filter&quot;: {&quot;$orderby&quot;: {&quot;TransactedDate&quot;: 1}},
      &quot;$projection&quot;: {&quot;$fields&quot;:       {
         &quot;TransactedDate&quot;: 1,
         &quot;_id&quot;: 1,
         &quot;Title&quot;: 1,
         &quot;_og&quot;: 1
      }}
   }
}

Nous pouvons aussi mettre deux id dans le roots :

{
  &quot;$roots&quot;:
[&quot;aeaaaaaaaaaam7mxaaa3gaky35ur6miaaaaq&quot;,&quot;aeaaaaaaaaaam7mxaadx2aky66alm6qaaaaq&quot;],
  &quot;$query&quot;: [],
  &quot;$filter&quot;: {
    &quot;$orderby&quot;: {
      &quot;TransactedDate&quot;: 1
    }
  },
  &quot;$projection&quot;: {
    &quot;$fields&quot;: {
      &quot;TransactedDate&quot;: 1,
      &quot;#id&quot;: 1,
      &quot;Title&quot;: 1,
      &quot;#object&quot;: 1
    }
  }
}
cela nous donne bien les deux unit dont les id sont dans le roots:

{
   &quot;$hits&quot;:    {
      &quot;total&quot;: 2,
      &quot;offset&quot;: 0,
      &quot;limit&quot;: 1,
      &quot;size&quot;: 2
   },
   &quot;$results&quot;:    [
            {
         &quot;Title&quot;: &quot;Armée de France.pdf&quot;,
         &quot;TransactedDate&quot;: &quot;2016-10-07T14:13:00&quot;,
         &quot;#id&quot;: &quot;aeaaaaaaaaaam7mxaadx2aky66alm6qaaaaq&quot;,
         &quot;#tenant&quot;: 0,
         &quot;#object&quot;: &quot;aeaaaaaaaaaam7mxaadx2aky66almyaaaaaq&quot;
      },
            {
         &quot;Title&quot;: &quot;PVI58fic_pour_empreinte_Appraisalerule&quot;,
         &quot;TransactedDate&quot;: &quot;2016-12-08T17:53:38&quot;,
         &quot;#id&quot;: &quot;aeaaaaaaaaaam7mxaaa3gaky35ur6miaaaaq&quot;,
         &quot;#tenant&quot;: 0,
         &quot;#object&quot;: &quot;aeaaaaaaaaaam7mxaaa3gaky35ur56yaaaba&quot;
      }
   ],
   &quot;$context&quot;:    {
      &quot;$roots&quot;:       [
         &quot;aeaaaaaaaaaam7mxaaa3gaky35ur6miaaaaq&quot;,
         &quot;aeaaaaaaaaaam7mxaadx2aky66alm6qaaaaq&quot;
      ],
      &quot;$query&quot;: [],
      &quot;$filter&quot;: {&quot;$orderby&quot;: {&quot;TransactedDate&quot;: 1}},
      &quot;$projection&quot;: {&quot;$fields&quot;:       {
         &quot;TransactedDate&quot;: 1,
         &quot;_id&quot;: 1,
         &quot;Title&quot;: 1,
         &quot;_og&quot;: 1
      }}
   }
}

En revanche, nous ne pouvons pas filtrer sur le titre si nous avons réduit
l&apos;ensemble dans le roots :

{
  &quot;$roots&quot;:
[&quot;aeaaaaaaaaaam7mxaaa3gaky35ur6miaaaaq&quot;,&quot;aeaaaaaaaaaam7mxaadx2aky66alm6qaaaaq&quot;],
  &quot;$query&quot;: [

      {
          &quot;$eq&quot;: {
            &quot;Title&quot;: &quot;PVI58fic_pour_empreinte_Appraisalerule&quot;
          }
        
      ,
      &quot;$depth&quot;: 20
    }
  ],
  &quot;$filter&quot;: {
    &quot;$orderby&quot;: {
      &quot;TransactedDate&quot;: 1
    }
  },
  &quot;$projection&quot;: {
    &quot;$fields&quot;: {
      &quot;TransactedDate&quot;: 1,
      &quot;#id&quot;: 1,
      &quot;Title&quot;: 1,
      &quot;#object&quot;: 1
    }
  }
}

Cette requête nous renvoie 0 résultat :

{
   &quot;$hits&quot;:    {
      &quot;total&quot;: 0,
      &quot;offset&quot;: 0,
      &quot;limit&quot;: 1,
      &quot;size&quot;: 0
   },
   &quot;$results&quot;: [],
   &quot;$context&quot;:    {
      &quot;$roots&quot;:       [
         &quot;aeaaaaaaaaaam7mxaaa3gaky35ur6miaaaaq&quot;,
         &quot;aeaaaaaaaaaam7mxaadx2aky66alm6qaaaaq&quot;
      ],
      &quot;$query&quot;: [{&quot;$eq&quot;: {&quot;Title&quot;: &quot;PVI58fic_pour_empreinte_Appraisalerule&quot;}}],
      &quot;$filter&quot;: {&quot;$orderby&quot;: {&quot;TransactedDate&quot;: 1}},
      &quot;$projection&quot;: {&quot;$fields&quot;:       {
         &quot;TransactedDate&quot;: 1,
         &quot;_id&quot;: 1,
         &quot;Title&quot;: 1,
         &quot;_og&quot;: 1
      }}
   }
}

Étapes pour le reproduire: 
Nous joignons un SIP mais les id internes VITAM ne seront pas les mêmes.
Il suffit de récupérer deux id VITAM dans la BDD pour reproduire le test.



Informations complémentaires: 
PVI-455
dans le cas de test, la démarche est la même mais sur deux collections;

====================================================================== 

Historique du bogue 
Date de modificationNom d’utilisateurChamp                    Changement      
    
====================================================================== 
2016-12-19 14:09 Franck         Nouveau bogue                                
2016-12-19 14:09 Franck         Fichier ajouté: SIP-20161208175358.zip         
          
======================================================================</TextContent>
</Content>